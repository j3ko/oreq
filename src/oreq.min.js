/*! oreq v0.0.1 | 2014-09-06 */
!function(a){function b(a){return a instanceof Array}function c(a){return"[object Number]"==Object.prototype.toString.call(a)}function d(a){return"[object String]"==Object.prototype.toString.call(a)}function e(a){return"undefined"==typeof a}function f(a,b){return e(b)?a instanceof w:a instanceof b}function g(a){return a instanceof t}function h(a){return g(a)?99:d(a)?r[a]||50:r[a.value]||50}function i(a){for(var b=[],c=[],d=0;d<a.length;d++){var f=a[d];if("("==f)c.push(f);else if(")"==f){for(;"("!=c.peek()&&!e(c.peek());)b.push(c.pop());c.pop()}else{for(;c.length;){var g=c.peek(),i=h(g),j=h(f);if(!(i>=j))break;b.push(c.pop())}c.push(f)}}for(;c.length;)b.push(c.pop());return b}function j(a){if(a&&a.length){for(var b=(a.join(" "),[]);a.length;){var c=a.shift();if(c instanceof v){var d=b.pop(),e=l(c,d);b.push(new t(e))}else if(c instanceof u){var f=b.pop(),g=b.pop(),h=k(c,g,f);b.push(new t(h))}else b.push(c)}return b.pop().value}}function k(a,b,c){return"any"==a.value||"all"==a.value?b.value+"/"+a.value+"(x: "+c.value+")":"substringof"==a.value||"endswith"==a.value||"startswith"==a.value?a.value+"("+b.value+","+c.value+")":[b.value,a.value,c.value].join(" ")}function l(a,b){return"year"==a.value?a.value+"("+b.value+")":void 0}function m(a,b){var c=a.root,d=[],f=b?function(a){return a}:escape;e(a.expand)||d.push("$expand="+f(a.expand)),e(a.format)||d.push("$format="+f(a.format)),e(a.filter)||d.push("$filter="+f(a.filter)),e(a.orderby)||d.push("$orderby="+f(a.orderby)),e(a.top)||d.push("$top="+f(a.top)),e(a.skip)||d.push("$skip="+f(a.skip)),e(a.select)||d.push("$select="+f(a.select)),e(a.inlinecount)||d.push("$inlinecount="+f(a.inlinecount));var g=d.join("&");return c=c||"",c&&g&&(c+="?"),g&&(c+=g),c}function n(a,b){var c={root:a.root},d=b?function(a){return a}:escape;return e(a.expand)||(c.$expand=d(a.expand)),e(a.format)||(c.$format=d(a.format)),e(a.filter)||(c.$filter=d(a.filter)),e(a.orderby)||(c.$orderby=d(a.orderby)),e(a.top)||(c.$top=d(a.top)),e(a.skip)||(c.$skip=d(a.skip)),e(a.select)||(c.$select=d(a.select)),e(a.inlinecount)||(c.$inlinecount=d(a.inlinecount)),c}function o(a,b){this.value=b,w.call(this,a),this.addInternal("("),this.addOperand(b)}Array.prototype.peek=function(){return this[this.length-1]};var p=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a},q=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.prototype[c]=b[c]);return a};a.request=function(a){return new s(a)},a.filter=function(a,b){return new o([],a,b)};var r={"(":1},s=function(a){return this.req={root:a},this};s.prototype={withExpand:function(a){return b(a)&&a.length>0?this.req.expand=a.join(","):b(a)||(this.req.expand=a),this},withOrderby:function(a){return b(a)&&a.length>0?this.req.orderby=a.join(","):b(a)||(this.req.orderby=a),this},withFormat:function(a){return this.req.format=a,this},withSkip:function(a){return this.req.skip=a,this},withTop:function(a){return this.req.top=a,this},withFilter:function(a){if(f(a,y))this.req.filter=a.evalInfix();else{if(!(null===a||e(a)||d(a)||c(a)))throw new Error("Invalid filter expression");this.req.filter=a}return this},withInlineCount:function(){return this.req.inlinecount="allpages",this},withSelect:function(a){return b(a)&&a.length>0?this.req.select=a.join(","):b(a)||(this.req.select=a),this},url:function(a){return m(this.req,a)},param:function(a){return n(this.req,a)}};var t=function(a){this.value=a};t.prototype.toString=function(){return"opd:"+this.value};var u=function(a){this.value=a};u.prototype.toString=function(){return"opr:"+this.value};var v=function(a){u.call(this,a)};v.prototype.toString=function(){return"uopr:"+this.value},p(v,u);var w=function(a){this.infix=a,this.field=this};w.prototype.addOperand=function(a){this.infix.push(new t(a))},w.prototype.addOperator=function(a){this.infix.push(new u(a))},w.prototype.addUnaryOperator=function(a){this.infix.push(new v(a))},w.prototype.addInternal=function(a){this.infix.push(a)},w.prototype.addLambda=function(a){if(this.infix.push("("),b(a))for(var c=0;c<a.length;c++)g(a[c])&&(e(a[c].value)?a[c].value="x":d(a[c].value)&&0===a[c].value.indexOf("/")&&(a[c].value="x"+a[c].value));this.infix=this.infix.concat(a),this.infix.push(")")},w.prototype.evalInfix=function(){for(var a=0,b=0;b<this.infix.length;b++)("("==this.infix[b]||")"==this.infix[b])&&a++;a%2!==0&&this.addInternal(")");var c=i(this.infix),d=j(c);return d};var x=function(a){w.call(this,a)};p(x,w),x.prototype.eq=function(a){return this.addOperator("eq"),this.addOperand(a),new y(this.infix)},x.prototype.ne=function(a){return this.addOperator("ne"),this.addOperand(a),new y(this.infix)},x.prototype.gt=function(a){return this.addOperator("gt"),this.addOperand(a),new y(this.infix)},x.prototype.ge=function(a){return this.addOperator("ge"),this.addOperand(a),new y(this.infix)},x.prototype.lt=function(a){return this.addOperator("lt"),this.addOperand(a),new y(this.infix)},x.prototype.le=function(a){return this.addOperator("le"),this.addOperand(a),new y(this.infix)},x.prototype.not=function(a){return this.addOperator("not"),this.addOperand(a),new y(this.infix)},x.prototype.add=function(a){return this.addOperator("add"),this.addOperand(a),new x(this.infix)},x.prototype.sub=function(a){return this.addOperator("sub"),this.addOperand(a),new x(this.infix)},x.prototype.mul=function(a){return this.addOperator("mul"),this.addOperand(a),new x(this.infix)},x.prototype.div=function(a){return this.addOperator("div"),this.addOperand(a),new x(this.infix)},x.prototype.mod=function(a){return this.addOperator("mod"),this.addOperand(a),new x(this.infix)};var y=function(a){w.call(this,a)};p(y,x),y.prototype.filter=function(a,b){return new o(this.infix,a,b)},y.prototype.and=function(){return this.addInternal(")"),this.addOperator("and"),new y(this.infix)},y.prototype.or=function(){return this.addInternal(")"),this.addOperator("or"),new y(this.infix)},p(o,x),o.prototype.any=function(a){return this.addOperator("any"),this.addLambda(a.infix),this.addInternal(")"),new y(this.infix)},o.prototype.all=function(a){return this.addOperator("all"),this.addLambda(a),this.addInternal(")"),new y(this.infix)},o.prototype.year=function(){return this.addUnaryOperator("year"),new x(this.infix)},o.prototype.month=function(){return this.addUnaryOperator("month"),new x(this.infix)},o.prototype.day=function(){return this.addUnaryOperator("day"),new x(this.infix)},o.prototype.hour=function(){return this.addUnaryOperator("hour"),new x(this.infix)},o.prototype.minute=function(){return this.addUnaryOperator("minute"),new x(this.infix)},o.prototype.second=function(){return this.addUnaryOperator("second"),new x(this.infix)},o.prototype.substringOf=function(a){return this.addOperator("substringof"),this.addOperand(a),this.addInternal(")"),new y(this.infix)},o.prototype.endsWith=function(a){return this.addOperator("endswith"),this.addOperand(a),this.addInternal(")"),new y(this.infix)},o.prototype.startsWith=function(a){return this.addOperator("startswith"),this.addOperand(a),this.addInternal(")"),new y(this.infix)},o.prototype.indexOf=function(a){return this.addOperator("indexof"),this.addOperand(a),this.addInternal(")"),new x(this.infix)},a.filterMixin=function(a){q(o,a)},a.filterMixin({eqOr:function(a){var c=oreq;if(b(a))for(var d=0;d<a.length;d++)c=c.filter(this.value).eq(a[d]),a.length!=d+1&&c.or();else a&&(c=c.filter(this.value).eq(a));return c},yearEqOr:function(a){var c=oreq;if(b(a))for(var d=0;d<a.length;d++)c=c.filter(this.value).year().eq(a[d]),a.length!=d+1&&c.or();else a&&(c=c.filter(this.value).year().eq(a));return c},anyOr:function(a,c){var d=oreq;if(b(a))for(var e=0;e<a.length;e++)d=d.filter(c).eq(a[e]),a.length!=e+1&&d.or();else a&&(d=d.filter(c).eq(a));return this.any(d)},anyYearOr:function(a,c){var d=oreq;if(b(a))for(var e=0;e<a.length;e++)d=d.filter(c).year().eq(a[e]),a.length!=e+1&&d.or();else a&&(d=d.filter(c).year().eq(a));return this.any(d)}})}("undefined"==typeof exports?this.oreq={}:exports);