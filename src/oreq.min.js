/*! oreq v0.0.1 | 2014-03-13 */
!function(a){function b(a){return a instanceof Array}function c(a){return"[object Number]"==Object.prototype.toString.call(a)}function d(a){return"[object String]"==Object.prototype.toString.call(a)}function e(a){return"undefined"==typeof a}function f(a,b){return e(b)?a instanceof v:a instanceof b}function g(a){return a instanceof s}function h(a){return g(a)?99:d(a)?q[a]||50:q[a.value]||50}function i(a){for(var b=[],c=[],d=0;d<a.length;d++){var f=a[d];if("("==f)c.push(f);else if(")"==f){for(;"("!=c.peek()&&!e(c.peek());)b.push(c.pop());c.pop()}else{for(;c.length;){var g=c.peek(),i=h(g),j=h(f);if(!(i>=j))break;b.push(c.pop())}c.push(f)}}for(;c.length;)b.push(c.pop());return b}function j(a){if(a&&a.length){var b=a.join(" ");console.log(b);for(var c=[];a.length;){var d=a.shift();if(d instanceof u){var e=c.pop(),f=l(d,e);c.push(new s(f))}else if(d instanceof t){var g=c.pop(),h=c.pop(),i=k(d,h,g);c.push(new s(i))}else c.push(d)}return c.pop().value}}function k(a,b,c){return"any"==a.value||"all"==a.value?b.value+"/"+a.value+"(x: "+c.value+")":"substringof"==a.value||"endswith"==a.value||"startswith"==a.value?a.value+"("+b.value+","+c.value+")":[b.value,a.value,c.value].join(" ")}function l(a,b){return"year"==a.value?a.value+"("+b.value+")":void 0}function m(a,b){var c=a.root,d=[],f=b?function(a){return a}:escape;e(a.expand)||d.push("$expand="+f(a.expand)),e(a.format)||d.push("$format="+f(a.format)),e(a.filter)||d.push("$filter="+f(a.filter)),e(a.orderby)||d.push("$orderby="+f(a.orderby)),e(a.top)||d.push("$top="+f(a.top)),e(a.skip)||d.push("$skip="+f(a.skip)),e(a.select)||d.push("$select="+f(a.select)),e(a.inlinecount)||d.push("$inlinecount="+f(a.inlinecount));var g=d.join("&");return c=c||"",c&&g&&(c+="?"),g&&(c+=g),c}function n(a,b){this.value=b,v.call(this,a),this.addInternal("("),this.addOperand(b)}Array.prototype.peek=function(){return this[this.length-1]};var o=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a},p=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.prototype[c]=b[c]);return a};a.request=function(a){return new r(a)},a.filter=function(a,b){return new n([],a,b)};var q={"(":1},r=function(a){return this.req={root:a},this};r.prototype={withExpand:function(a){return b(a)&&a.length>0?this.req.expand=a.join(","):b(a)||(this.req.expand=a),this},withOrderby:function(a){return b(a)&&a.length>0?this.req.orderby=a.join(","):b(a)||(this.req.orderby=a),this},withFormat:function(a){return this.req.format=a,this},withSkip:function(a){return this.req.skip=a,this},withTop:function(a){return this.req.top=a,this},withFilter:function(a){if(f(a,x))this.req.filter=a.evalInfix();else{if(!(null===a||e(a)||d(a)||c(a)))throw new Error("Invalid filter expression");this.req.filter=a}return this},withInlineCount:function(){return this.req.inlinecount="allpages",this},withSelect:function(a){return b(a)&&a.length>0?this.req.select=a.join(","):b(a)||(this.req.select=a),this},url:function(a){return m(this.req,a)}};var s=function(a){this.value=a};s.prototype.toString=function(){return"opd:"+this.value};var t=function(a){this.value=a};t.prototype.toString=function(){return"opr:"+this.value};var u=function(a){t.call(this,a)};u.prototype.toString=function(){return"uopr:"+this.value},o(u,t);var v=function(a){this.infix=a,this.field=this};v.prototype.addOperand=function(a){this.infix.push(new s(a))},v.prototype.addOperator=function(a){this.infix.push(new t(a))},v.prototype.addUnaryOperator=function(a){this.infix.push(new u(a))},v.prototype.addInternal=function(a){this.infix.push(a)},v.prototype.addLambda=function(a){if(this.infix.push("("),b(a))for(var c=0;c<a.length;c++)g(a[c])&&(e(a[c].value)?a[c].value="x":d(a[c].value)&&0===a[c].value.indexOf("/")&&(a[c].value="x"+a[c].value));this.infix=this.infix.concat(a),this.infix.push(")")},v.prototype.evalInfix=function(){for(var a=0,b=0;b<this.infix.length;b++)("("==this.infix[b]||")"==this.infix[b])&&a++;a%2!==0&&this.addInternal(")");var c=this.infix.join(" ");console.log(c);var d=i(this.infix),e=j(d);return console.log(e),e};var w=function(a){v.call(this,a)};o(w,v),w.prototype.eq=function(a){return this.addOperator("eq"),this.addOperand(a),new x(this.infix)},w.prototype.ne=function(a){return this.addOperator("ne"),this.addOperand(a),new x(this.infix)},w.prototype.gt=function(a){return this.addOperator("gt"),this.addOperand(a),new x(this.infix)},w.prototype.ge=function(a){return this.addOperator("ge"),this.addOperand(a),new x(this.infix)},w.prototype.lt=function(a){return this.addOperator("lt"),this.addOperand(a),new x(this.infix)},w.prototype.le=function(a){return this.addOperator("le"),this.addOperand(a),new x(this.infix)},w.prototype.not=function(a){return this.addOperator("not"),this.addOperand(a),new x(this.infix)},w.prototype.add=function(a){return this.addOperator("add"),this.addOperand(a),new w(this.infix)},w.prototype.sub=function(a){return this.addOperator("sub"),this.addOperand(a),new w(this.infix)},w.prototype.mul=function(a){return this.addOperator("mul"),this.addOperand(a),new w(this.infix)},w.prototype.div=function(a){return this.addOperator("div"),this.addOperand(a),new w(this.infix)},w.prototype.mod=function(a){return this.addOperator("mod"),this.addOperand(a),new w(this.infix)};var x=function(a){v.call(this,a)};o(x,w),x.prototype.filter=function(a,b){return new n(this.infix,a,b)},x.prototype.and=function(){return this.addInternal(")"),this.addOperator("and"),new x(this.infix)},x.prototype.or=function(){return this.addInternal(")"),this.addOperator("or"),new x(this.infix)},o(n,w),n.prototype.any=function(a){return this.addOperator("any"),this.addLambda(a.infix),this.addInternal(")"),new x(this.infix)},n.prototype.all=function(a){return this.addOperator("all"),this.addLambda(a),this.addInternal(")"),new x(this.infix)},n.prototype.year=function(){return this.addUnaryOperator("year"),new w(this.infix)},n.prototype.month=function(){return this.addUnaryOperator("month"),new w(this.infix)},n.prototype.day=function(){return this.addUnaryOperator("day"),new w(this.infix)},n.prototype.hour=function(){return this.addUnaryOperator("hour"),new w(this.infix)},n.prototype.minute=function(){return this.addUnaryOperator("minute"),new w(this.infix)},n.prototype.second=function(){return this.addUnaryOperator("second"),new w(this.infix)},n.prototype.substringOf=function(a){return this.addOperator("substringof"),this.addOperand(a),this.addInternal(")"),new x(this.infix)},n.prototype.endsWith=function(a){return this.addOperator("endswith"),this.addOperand(a),this.addInternal(")"),new x(this.infix)},n.prototype.startsWith=function(a){return this.addOperator("startswith"),this.addOperand(a),this.addInternal(")"),new x(this.infix)},n.prototype.indexOf=function(a){return this.addOperator("indexof"),this.addOperand(a),this.addInternal(")"),new w(this.infix)},a.filterMixin=function(a){p(n,a)},a.filterMixin({eqOr:function(a){var c=oreq;if(b(a))for(var d=0;d<a.length;d++)c=c.filter(this.value).eq(a[d]),a.length!=d+1&&c.or();else a&&(c=c.filter(this.value).eq(a));return c},yearEqOr:function(a){var c=oreq;if(b(a))for(var d=0;d<a.length;d++)c=c.filter(this.value).year().eq(a[d]),a.length!=d+1&&c.or();else a&&(c=c.filter(this.value).year().eq(a));return c},anyOr:function(a,c){var d=oreq;if(b(a))for(var e=0;e<a.length;e++)d=d.filter(c).eq(a[e]),a.length!=e+1&&d.or();else a&&(d=d.filter(c).eq(a));return this.any(d)},anyYearOr:function(a,c){var d=oreq;if(b(a))for(var e=0;e<a.length;e++)d=d.filter(c).year().eq(a[e]),a.length!=e+1&&d.or();else a&&(d=d.filter(c).year().eq(a));return this.any(d)}})}("undefined"==typeof exports?this.oreq={}:exports);